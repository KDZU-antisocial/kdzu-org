# üó∫Ô∏è Sitemap System Documentation

This document explains how the sitemap system works for the KDZU.org website, including setup, configuration, testing, and deployment.

## üìã Overview

The sitemap system automatically generates XML sitemaps for search engines to discover and index all website content. It's designed to work with both local development and production deployment to Cloudflare R2 via GitHub Actions.

## ÔøΩÔøΩÔ∏è Architecture

### Custom Sitemap Generation
- **Local Development**: Dynamic sitemap generation via custom API endpoint
- **Production Build**: Sitemap generated as part of the build process
- **Deployment**: Sitemap endpoint available at runtime for SSR builds

### File Structure
```
src/pages/
‚îî‚îÄ‚îÄ sitemap.xml.ts         ‚Üê Custom sitemap endpoint
```

## ‚öôÔ∏è Configuration

### Custom Sitemap Endpoint (`src/pages/sitemap.xml.ts`)
The sitemap is generated by a custom TypeScript endpoint that:
- Fetches content from all collections
- Applies custom priorities and change frequencies
- Filters out draft/private posts
- Generates proper XML output

### Robots.txt (`src/pages/robots.txt.astro`)
```astro
---
const baseUrl = 'https://kdzu.org';
---
# Allow all crawlers
User-agent: *
Allow: /

# Sitemap location
Sitemap: {baseUrl}/sitemap.xml
```

## üîß How It Works

### 1. Content Discovery
The custom sitemap endpoint automatically discovers:
- **Static Pages**: All `.astro` files in `src/pages/`
- **Content Collections**: Tracks, MDC posts, events, staticsignal posts
- **Dynamic Routes**: Generated from content collection schemas

### 2. URL Generation
- **Base URL**: `https://kdzu.org/`
- **Trailing Slashes**: Always included (matches site configuration)
- **Content URLs**: Generated from collection slugs and metadata

### 3. SEO Metadata
Each URL includes:
- **Priority**: 1.0 (homepage), 0.9 (main sections), 0.7 (content), 0.5 (privacy)
- **Change Frequency**: daily (homepage), weekly (main sections), monthly (content), yearly (privacy)
- **Last Modified**: Current date for static pages, `pubDate` for content

### 4. Draft Filtering
Automatically excludes content starting with underscore:
- `_track.md.template` ‚Üí ‚ùå Excluded
- `_omsa-transmission-analysis.mdx` ‚Üí ‚ùå Excluded
- `without-you.md` ‚Üí ‚úÖ Included

## üß™ Testing

### Local Development Testing

#### 1. Start Dev Server
```bash
npm run dev
```

#### 2. Test Sitemap Endpoint
```bash
# Check sitemap content
curl -s http://localhost:4321/sitemap.xml | head -20

# Count total URLs
curl -s http://localhost:4321/sitemap.xml | grep -c "<url>"

# Verify draft filtering
curl -s http://localhost:4321/sitemap.xml | grep -E "_track|_omsa|_narrative|_example" | wc -l
# Should return: 0
```

#### 3. Test Individual URLs
```bash
# Test static pages
curl -s -o /dev/null -w "Homepage: %{http_code}\n" http://localhost:4321/
curl -s -o /dev/null -w "About: %{http_code}\n" http://localhost:4321/about/
curl -s -o /dev/null -w "Events: %{http_code}\n" http://localhost:4321/events/

# Test content pages
curl -s -o /dev/null -w "Track: %{http_code}\n" http://localhost:4321/tracks-we-love/without-you/
curl -s -o /dev/null -w "MDC: %{http_code}\n" http://localhost:4321/mdc/scouting-the-arroyo-seco/
```

### Build Testing

#### 1. Generate Build Files
```bash
npm run build
```

#### 2. Verify Sitemap Endpoint
```bash
# Check if sitemap endpoint was built
find dist -name "*sitemap*" -type f

# The sitemap will be available at runtime, not as static files
```

## üöÄ Deployment

### GitHub Actions Workflow
The sitemap is automatically available after deployment:

1. **Build Step**: `npm run build` creates the sitemap endpoint
2. **Deploy Step**: Site deployed to Cloudflare Workers (SSR)
3. **Result**: Sitemap available at runtime via `/sitemap.xml`

### Production URLs
- **Sitemap**: `https://kdzu.org/sitemap.xml`
- **Robots.txt**: `https://kdzu.org/robots.txt`

### Manual Deployment
```bash
# Build locally
npm run build

# Deploy using your script
./deploy-site.sh
```

## üìä Content Coverage

### Static Pages
- Homepage (`/`) - Priority: 1.0, Frequency: daily
- About (`/about/`) - Priority: 0.9, Frequency: monthly
- Events (`/events/`) - Priority: 0.9, Frequency: weekly
- Tracks (`/tracks-we-love/`) - Priority: 0.9, Frequency: weekly
- MDC (`/mdc/`) - Priority: 0.9, Frequency: weekly
- Static (`/static/`) - Priority: 0.9, Frequency: weekly
- Privacy Policy (`/privacy-policy/`) - Priority: 0.5, Frequency: yearly

### Dynamic Content
- **Tracks**: All published tracks from `src/content/tracks/`
- **MDC Posts**: All published posts from `src/content/mdc/`
- **Events**: Event listings (individual event pages not included)
- **Staticsignal Posts**: Currently all are drafts (excluded)

### Example Sitemap Entry
```xml
<url>
  <loc>https://kdzu.org/tracks-we-love/without-you/</loc>
  <lastmod>2025-06-17</lastmod>
  <changefreq>monthly</changefreq>
  <priority>0.7</priority>
</url>
```

## üîç Troubleshooting

### Common Issues

#### Sitemap Not Generating
```bash
# Check if sitemap endpoint exists
ls -la src/pages/sitemap.xml.ts

# Verify TypeScript compilation
npm run astro check
```

#### Missing Content
```bash
# Check content collections
ls -la src/content/tracks/
ls -la src/content/mdc/

# Verify collection schemas
cat src/content/config.ts
```

#### Build Errors
```bash
# Clean build
rm -rf dist/
npm run build

# Check for TypeScript errors
npm run astro check
```

### Debug Commands
```bash
# View build output
npm run build 2>&1 | tee build.log

# Check generated files
ls -la dist/

# Test sitemap locally
npm run dev &
sleep 5
curl -s http://localhost:4321/sitemap.xml | head -20
```

## üìà Monitoring

### Search Console
1. Submit sitemap URL: `https://kdzu.org/sitemap.xml`
2. Monitor indexing status
3. Check for crawl errors

### Analytics
- Monitor `/sitemap.xml` page views
- Track search engine bot activity
- Monitor 404 errors for sitemap URLs

## üîÑ Maintenance

### Regular Tasks
- **Monthly**: Review sitemap content coverage
- **Quarterly**: Update sitemap priorities and frequencies
- **Annually**: Review and update robots.txt

### Content Updates
- **New Content**: Automatically included in next build
- **Removed Content**: Automatically excluded from next build
- **Draft Posts**: Use underscore prefix to exclude from sitemap

### Performance
- **File Size**: Monitor sitemap response size
- **URL Count**: Keep under 50,000 URLs per sitemap
- **Update Frequency**: Balance freshness with crawl efficiency

## üìö Resources

- [Astro API Routes](https://docs.astro.build/en/core-concepts/astro-pages/#api-routes)
- [Sitemap Protocol](https://www.sitemaps.org/protocol.html)
- [Google Sitemap Guidelines](https://developers.google.com/search/docs/advanced/sitemaps/overview)
- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/)

---

**Last Updated**: September 1, 2025  
**Maintainer**: KDZU Development Team  
**Version**: 1.0.0 